<html>
<head>
    <title>A Simple SPA For Recipes</title>
    <script type="application/javascript">
        function displayAllRecipes() {
            clearRecipesTable();
            fetchAllRecipes().then(displayRecipes)
        }

        function displayRecipesWithLabel() {
            clearRecipesTable();
            const label = readRecipeLabel();
            fetchRecipesWithLabel(label).then(displayRecipes)
        }

        function displayRecipe(title) {
            fetchRecipeWithName(title).then(t =>
                recipeDisplay().innerHTML
                    = `${t.label} label recipe ${t.title} with description "${t.description}"`
            )
        }

        function deleteRecipe(id) {
            deleteRecipeWithId(id).then(() => {
                clearRecipeDisplay();
                displayAllRecipes();
            })
        }

        function deleteRecipeWithId(uuid) {
            return sendDELETE(`/recipes?uuid=${uuid}`)
        }

        function addNewRecipe() {
            const recipe = buildRecipeFromForm();
            sendPOST("/recipes", recipe).then(displayAllRecipes);
        }

        function buildRecipeFromForm() {
            return {
                title: getRecipeFormValue("title"),
                description: getRecipeFormValue("newRecipeDescription"),
                label: getRecipeFormValue("newRecipeLabel"),
                prepTimeMins: getRecipeFormValue("prepTimeMins"),
                recipeUrl: getRecipeFormValue("recipeUrl"),
                imageUrl: getRecipeFormValue("imageUrl")
            }
        }

        function getRecipeFormValue(controlName) {
            return document.addRecipeForm[controlName].value;
        }

        function recipeDisplay() {
            return document.getElementById("currentRecipeDisplay");
        }

        function readRecipeLabel() {
            return document.labelForm.label.value
        }

        function fetchRecipesWithLabel(label) {
            return sendGET(`/recipes/byLabel?label=${label}`);
        }

        function fetchRecipeWithName(title) {
            return sendGET(`/recipes/byName?title=${title}`);
        }

        function fetchAllRecipes() {
            return sendGET("/recipes")
        }

        function sendGET(url) {
            return fetch(
                url,
                {headers: {'Accept': 'application/json'}}
            ).then(response => {
                if (response.ok) {
                    return response.json()
                }
                return [];
            });
        }

        function sendPOST(url, data) {
            return fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        function sendDELETE(url) {
            return fetch(url, {
                method: "DELETE"
            });
        }

        function recipesTable() {
            return document.getElementById("recipesTableBody");
        }

        function clearRecipesTable() {
            recipesTable().innerHTML = "";
        }

        function clearRecipeDisplay() {
            recipeDisplay().innerText = "None";
        }

        function displayRecipes(recipes) {
            const recipesTableBody = recipesTable()
            recipes.forEach(recipe => {
                const newRow = recipeRow(recipe);
                recipesTableBody.appendChild(newRow);
            });
        }

        function recipeRow(recipe) {
            return tr([
                td(recipe.uuid),
                td(recipe.title),
                td(recipe.label),
                td(viewLink(recipe.title)),
                td(deleteLink(recipe.uuid)),
            ]);
        }

        function tr(children) {
            const node = document.createElement("tr");
            children.forEach(child => node.appendChild(child));
            return node;
        }

        function td(content) {
            const node = document.createElement("td");
            if (content instanceof Element) {
                node.appendChild(content)
            } else {
                node.appendChild(document.createTextNode(content));
            }
            return node;
        }

        function viewLink(title) {
            const node = document.createElement("a");
            node.setAttribute(
                "href", `javascript:displayRecipe("${title}")`
            )
            node.appendChild(document.createTextNode("view"));
            return node;
        }

        function deleteLink(uuid) {
            const node = document.createElement("a");
            node.setAttribute(
                "href", `javascript:deleteRecipe("${uuid}")`
            )
            node.appendChild(document.createTextNode("delete"));
            return node;
        }
    </script>
</head>
<body onload="displayAllRecipes()">
<h1>Recipe Manager Client</h1>
<form action="javascript:displayAllRecipes()">
    <span>View all the recipes</span>
    <input type="submit" value="Go">
</form>
<form action="javascript:displayRecipesWithLabel()" name="labelForm">
    <span>View recipes with label</span>
    <select name="label">
        <option name="LowCarb">LowCarb</option>
        <option name="Mediterranean">Mediterranean</option>
        <option name="Vegetarian">Vegetarian</option>
        <option name="Pescatarian">Pescatarian</option>
        <option name="Spanish">Spanish</option>
        <option name="NewAmerican">NewAmerican</option>
        <option name="French">French</option>
        <option name="Vegan">Vegan</option>
        <option name="Caribbean">Caribbean</option>
        <option name="Italian">Italian</option>
    </select>
    <input type="submit" value="Go">
</form>
<form action="javascript:addNewRecipe()" name="addRecipeForm">
    <span>Create new recipe with</span>
    <label for="title">title</label>
    <input id="title" name="title" size="10" type="text">
    <label for="newRecipeDescription">description</label>
    <input id="newRecipeDescription" name="newRecipeDescription" size="20" type="text">
    <label for="newRecipeLabel">label</label>
    <select id="newRecipeLabel" name="newRecipeLabel">
        <option name="LowCarb">LowCarb</option>
        <option name="Mediterranean">Mediterranean</option>
        <option name="Vegetarian">Vegetarian</option>
        <option name="Pescatarian">Pescatarian</option>
        <option name="Spanish">Spanish</option>
        <option name="NewAmerican">NewAmerican</option>
        <option name="French">French</option>
        <option name="Vegan">Vegan</option>
        <option name="Caribbean">Caribbean</option>
        <option name="Italian">Italian</option>
    </select>
    <label for="prepTimeMins"> prep Time: </label>
    <input id="prepTimeMins" name="prepTimeMins" size="3" type="text">
    <label for="imageUrl"> Image URL: </label>
    <input id="imageUrl" name="imageUrl" size="20" type="text">
    <label for="recipeUrl"> Recipe URL: </label>
    <input id="recipeUrl" name="recipeUrl" size="20" type="text">
    <input type="submit" value="Go">
</form>
<hr>
<div>
    Current recipe is <em id="currentRecipeDisplay">None</em>
</div>
<hr>
<table>
    <thead>
    <tr>
        <th> Id</th>
        <th> Title</th>
        <th> Label</th>
        <th></th>
        <th></th>
    </tr>
    </thead>
    <tbody id="recipesTableBody">
    </tbody>
</table>
</body>
</html>